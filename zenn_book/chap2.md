# re2c の基本

## re2c の概要

Lexなどの生成ツールでは正規表現ルールを記述したファイルから独立したC言語のソースコードを生成しますが、

re2c ではソースコードの一部に re2c のルールに従ったDSLをコメントの形式で記述し、`re2c` コマンドを実行することでDSL部分を字句解析プログラムに置換します。

以下が re2c を利用するサンプルコードです。
`/*!re2c .... */` のコメントの間にDSLを記載します。

```c:simple.re.c
#include <assert.h>

int lex(const char *YYCURSOR)
{
/*!re2c
    re2c:define:YYCTYPE = char;
    re2c:yyfill:enable = 0;

    *       { return 1; }
    [a-z]+  { return 0; }
*/
}

int main()
{
    assert(lex("foo") == 0);
    assert(lex("012") == 1);
    return 0;
}
```

このコードを `re2c` コマンドに食わせます。

:::message
re2c のコードは拡張子を `.re` にするのが慣習のようですが、コード補完やシンタックスハイライトの設定が面倒なので、この書籍ではre2cの拡張子を `re.c` としています。
:::

```bash
$ re2c -i -o simple.c simple.re.c
```

すると以下のようなコードが生成されます。

```c:simple.c
/* Generated by re2c 2.0.3 on Fri Dec 11 04:04:29 2020 */
#include <assert.h>

int lex(const char *YYCURSOR)
{

{
	char yych;
	yych = *YYCURSOR;
	switch (yych) {
	case 'a':
	case 'b':
	case 'c':
	case 'd':
	case 'e':
	case 'f':
	case 'g':
	case 'h':
	case 'i':
	case 'j':
	case 'k':
	case 'l':
	case 'm':
	case 'n':
	case 'o':
	case 'p':
	case 'q':
	case 'r':
	case 's':
	case 't':
	case 'u':
	case 'v':
	case 'w':
	case 'x':
	case 'y':
	case 'z':	goto yy4;
	default:	goto yy2;
	}
yy2:
	++YYCURSOR;
	{ return 1; }
yy4:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'a':
	case 'b':
	case 'c':
	case 'd':
	case 'e':
	case 'f':
	case 'g':
	case 'h':
	case 'i':
	case 'j':
	case 'k':
	case 'l':
	case 'm':
	case 'n':
	case 'o':
	case 'p':
	case 'q':
	case 'r':
	case 's':
	case 't':
	case 'u':
	case 'v':
	case 'w':
	case 'x':
	case 'y':
	case 'z':	goto yy4;
	default:	goto yy6;
	}
yy6:
	{ return 0; }
}

}

int main()
{
    assert(lex("foo") == 0);
    assert(lex("012") == 1);
    return 0;
}
```

長大な`switch`と乱立する`goto`で面食らうかもしれませんが、非常にシンプルな正規表現ルールなので目で動作が追えると思います。
このように、re2cではソースコード中の一部に記載されたDSL部分だけを置換することで字句解析器を生成します。

LexのようにDSLから独立したプログラム全体を生成する方式と違い、re2c は字句解析器のコア部分だけを生成するため、関数のつなぎ目や呼び出し部分を自分でお膳立てする必要があります。
面倒のように思えるかもしれませんが、逆に動作を細かく指定することができ高い柔軟性が得られます。
これは生成されるソースコードのカスタマイズが難しいLexにはないアドバンテージです。

## DSL